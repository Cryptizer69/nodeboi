x-logging: &logging
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "3"
      tag: '{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}'

services:
  consensus:
    container_name: ${NODE_NAME}-lodestar
    image: chainsafe/lodestar:${LODESTAR_VERSION}
    restart: unless-stopped
    stop_grace_period: 1m
    stop_signal: SIGTERM
    user: "${NODE_UID}:${NODE_GID}"
    environment:
      - NODE_OPTIONS=--max-old-space-size=${LODESTAR_HEAP_MB}
    ports:
      - "${HOST_IP:-}:${CL_REST_PORT}:5052"
      - "${HOST_IP:-}:8008:8008"
      - "${HOST_IP:-}:${CL_P2P_PORT}:${CL_P2P_PORT}/tcp"
      - "${HOST_IP:-}:${CL_P2P_PORT}:${CL_P2P_PORT}/udp"
    volumes:
      - ./data/consensus:/opt/lodestar/data
      - ./jwt:/opt/lodestar/jwt:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        aliases:
          - eth2
          - lodestar
          - consensus
          - ${CONSENSUS_ALIAS:-default-consensus}
    <<: *logging
    command:
      - "beacon"
      - "--network"
      - "${NETWORK}"
      - "--dataDir"
      - "/opt/lodestar/data"
      - "--rest.address"
      - "0.0.0.0"
      - "--rest.port"
      - "5052"
      - "--port"
      - "${CL_P2P_PORT}"
      - "--execution.urls"
      - "http://execution:8551"
      - "--jwt-secret"
      - "/opt/lodestar/jwt/jwtsecret"
      - "--metrics"
      - "true"
      - "--metrics.address"
      - "0.0.0.0"
      - "--metrics.port"
      - "8008"
      - "--checkpointSyncUrl"
      - "${CHECKPOINT_SYNC_URL}"
      - "--forceCheckpointSync"
    labels:
      - prometheus.scrape=true
      - prometheus.job=lodestar
      - prometheus.port=8008
      - prometheus.path=/metrics
      - ethereum.client=lodestar
      - ethereum.layer=consensus
      - ethereum.network=${NETWORK}

networks:
  default:
    enable_ipv6: ${IPV6:-false}
